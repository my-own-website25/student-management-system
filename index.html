<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shariar's Medical Academy</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; } /* slate-200 */
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; } /* slate-400 */
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; } /* slate-500 */
        
        .tab-active {
            border-bottom-color: #0284c7; /* sky-600 */
            color: #0284c7; /* sky-600 */
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        /* Styles for correct/incorrect answers */
        .correct-answer { background-color: #dcfce7; border-left: 4px solid #22c55e; }
        .incorrect-answer { background-color: #fee2e2; border-left: 4px solid #ef4444; }
        .selected-answer { box-shadow: 0 0 0 2px #0ea5e9; } /* sky-500 */

        /* Modal Animation */
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
    </style>
</head>
<body class="text-slate-800 flex flex-col items-center justify-center min-h-screen py-8">

    <div class="w-full max-w-6xl mx-auto p-4">

        <!-- Main Landing View -->
        <div id="mainView" class="view bg-white p-8 rounded-xl shadow-xl text-center max-w-md mx-auto">
            <h1 class="text-3xl font-bold mb-2 text-slate-900">Shariar's Medical Academy</h1>
            <p class="text-slate-600 mb-8">Select your portal to continue.</p>
            <div class="flex flex-col space-y-4">
                <button onclick="showView('adminAuthView')" class="w-full bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-sky-700 transition-all duration-300 transform hover:scale-105">Admin Portal</button>
                <button onclick="showView('studentLoginView')" class="w-full bg-slate-700 text-white font-semibold py-3 px-4 rounded-lg hover:bg-slate-800 transition-all duration-300 transform hover:scale-105">Student Portal</button>
            </div>
        </div>
        
        <!-- Admin Auth Views -->
        <div id="adminAuthView" class="view hidden bg-white p-8 rounded-xl shadow-xl text-center max-w-md mx-auto">
            <button onclick="showView('mainView')" class="text-sky-600 hover:text-sky-800 mb-4 text-left w-full">&larr; Back</button>
            <h2 class="text-2xl font-bold mb-6">Admin Portal</h2>
            <div class="flex flex-col space-y-4">
                <button onclick="showView('adminLoginView')" class="w-full bg-sky-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-sky-600 transition-all duration-300">Login</button>
            </div>
        </div>
        <div id="adminLoginView" class="view hidden bg-white p-8 rounded-xl shadow-xl max-w-md mx-auto">
            <button onclick="showView('adminAuthView')" class="text-sky-600 hover:text-sky-800 mb-4">&larr; Back</button>
            <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
            <form id="adminLoginForm" class="space-y-6">
                <input type="email" id="adminLoginEmail" placeholder="Email" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                <input type="password" id="adminLoginPassword" placeholder="Password" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-lg text-white bg-sky-600 hover:bg-sky-700 transition-colors">Login</button>
            </form>
            <div id="adminLoginFeedback" class="mt-4 text-center text-red-600 font-medium"></div>
        </div>
        
        <!-- Admin Dashboard View -->
        <div id="adminDashboardView" class="view hidden bg-white p-8 rounded-xl shadow-xl">
            <div class="flex justify-between items-center mb-4 border-b border-slate-200 pb-4">
                 <h2 class="text-2xl font-bold text-slate-900">Admin Dashboard</h2>
                 <button onclick="logoutAdmin()" class="text-sm text-sky-600 hover:text-sky-800 font-semibold">Logout</button>
            </div>
            
            <!-- Tabs -->
            <div class="border-b border-slate-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button onclick="switchTab('studentManagementTab', this)" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">Students</button>
                    <button onclick="switchTab('batchManagementTab', this)" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500">Batches</button>
                    <button onclick="switchTab('contentManagementTab', this)" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500">Content</button>
                    <button onclick="switchTab('examManagementTab', this)" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500">Exams</button>
                </nav>
            </div>

            <!-- Student Management Tab Content -->
            <div id="studentManagementTab" class="tab-content mt-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Left Column: Create Students -->
                    <div class="space-y-6">
                        <form id="adminForm" class="space-y-4 p-4 border border-slate-200 rounded-lg bg-slate-50">
                            <h3 class="text-lg font-medium text-slate-900">Create New Student</h3>
                            <input type="text" id="studentName" placeholder="Student Name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input type="email" id="studentEmail" placeholder="Student Email" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <select id="studentBatch" required class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"><option value="">Assign to Batch</option></select>
                            <select id="paymentStatus" required class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <option value="">Select Payment Status</option>
                                <option value="not-paid">Not Paid</option>
                                <option value="first-installment">First Installment</option>
                                <option value="one-time">One Time Payment</option>
                                <option value="paid">Paid</option>
                            </select>
                            <input type="text" id="paymentAmount" placeholder="Amount (e.g., 250 USD)" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <div>
                                <label for="paymentDate" class="text-sm font-medium text-slate-700">Payment Date</label>
                                <input type="date" id="paymentDate" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-lg text-white bg-sky-600 hover:bg-sky-700 transition-colors">Create Student</button>
                        </form>
                        <div id="adminFeedback" class="mt-4 text-center"></div>
                    </div>

                    <!-- Right Column: Student List & Search -->
                    <div class="space-y-4">
                        <div class="flex space-x-2">
                            <input type="text" id="searchInput" placeholder="Search..." class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <select id="searchType" class="block w-48 px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <option value="name">By Name</option>
                                <option value="email">By Email</option>
                                <option value="batch">By Batch</option>
                            </select>
                        </div>
                        <div id="studentList" class="h-96 overflow-y-auto custom-scrollbar bg-slate-100 p-3 rounded-lg border border-slate-200"></div>
                    </div>
                </div>
            </div>

            <!-- Batch Management Tab Content -->
            <div id="batchManagementTab" class="tab-content hidden mt-8">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Left Column: Create Batch & Export -->
                    <div class="space-y-8">
                        <div class="space-y-4 p-4 border border-slate-200 rounded-lg bg-slate-50 h-fit">
                            <h3 class="text-lg font-medium text-slate-900">Create New Batch</h3>
                            <form id="batchForm" class="flex items-center space-x-2">
                                <input type="text" id="batchName" placeholder="Batch Name (e.g., Course D)" required class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-sky-600 rounded-lg hover:bg-sky-700 transition-colors">Create</button>
                            </form>
                            <div id="batchFeedback" class="text-sm mt-2"></div>
                        </div>
                        <div class="space-y-4 p-4 border border-slate-200 rounded-lg bg-slate-50 h-fit">
                            <h3 class="text-lg font-medium text-slate-900">Export Batch Data</h3>
                            <div class="flex items-center space-x-2">
                                <select id="exportBatchSelect" class="block w-full px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"><option value="">Select a Batch</option></select>
                                <button id="exportBtn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors">Download Excel</button>
                            </div>
                            <div id="exportFeedback" class="text-sm mt-2"></div>
                        </div>
                    </div>
                    <!-- Right Column: Batch List -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium text-slate-900">All Batches</h3>
                        <div id="batchList" class="h-[28rem] overflow-y-auto custom-scrollbar bg-slate-100 p-3 rounded-lg border border-slate-200"></div>
                    </div>
                </div>
            </div>
            
            <!-- Content Management Tab -->
            <div id="contentManagementTab" class="tab-content hidden mt-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Announcements -->
                    <div class="space-y-4 p-4 border border-slate-200 rounded-lg bg-slate-50">
                        <h3 class="text-lg font-medium text-slate-900">Announcements</h3>
                        <form id="announcementForm" class="space-y-3">
                            <input type="text" id="announcementTitle" placeholder="Announcement Title" required class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <select id="announcementBatchSelect" class="block w-full px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"><option value="all">All Batches</option></select>
                            <textarea id="announcementContent" placeholder="Announcement Details..." required rows="4" class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"></textarea>
                            <button type="submit" class="w-full py-2 px-4 rounded-lg text-white bg-sky-600 hover:bg-sky-700 transition-colors">Post Announcement</button>
                        </form>
                        <div id="announcementFeedback" class="text-sm"></div>
                        <div id="announcementListAdmin" class="h-60 overflow-y-auto custom-scrollbar space-y-2"></div>
                    </div>
                    <!-- Class Routines -->
                    <div class="space-y-4 p-4 border border-slate-200 rounded-lg bg-slate-50">
                        <h3 class="text-lg font-medium text-slate-900">Class Routines</h3>
                        <form id="routineForm" class="space-y-3">
                            <select id="routineBatchSelect" required class="block w-full px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"><option value="">Select a Batch</option></select>
                            <textarea id="routineContent" placeholder="Enter routine details or a link to an image/PDF..." required rows="6" class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"></textarea>
                            <button type="submit" class="w-full py-2 px-4 rounded-lg text-white bg-sky-600 hover:bg-sky-700 transition-colors">Set Routine</button>
                        </form>
                        <div id="routineFeedback" class="text-sm"></div>
                    </div>
                </div>
            </div>
            
            <!-- Exam Management Tab -->
            <div id="examManagementTab" class="tab-content hidden mt-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Create Exam Form -->
                    <div class="space-y-4 p-4 border border-slate-200 rounded-lg bg-slate-50">
                        <h3 class="text-lg font-medium text-slate-900">Create New Mock Exam</h3>
                        <form id="examForm" class="space-y-4">
                            <input type="text" id="examTitle" placeholder="Exam Title" required class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <div class="grid grid-cols-2 gap-4">
                                <select id="examBatch" required class="block w-full px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"><option value="">Assign to Batch</option></select>
                                <input type="number" id="examDuration" placeholder="Duration (minutes)" required class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <input type="number" id="examPassPercent" placeholder="Pass Percentage %" required min="1" max="100" class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            
                            <div class="border-t border-slate-200 pt-4">
                                <h4 class="font-medium text-slate-800 mb-2">Questions</h4>
                                <div id="questionsContainer" class="space-y-4">
                                    <!-- Questions will be added here dynamically -->
                                </div>
                                <button type="button" onclick="addQuestion()" class="mt-4 text-sm text-sky-600 hover:text-sky-800 font-semibold">+ Add Question</button>
                            </div>
                            
                            <button type="submit" class="w-full py-3 px-4 rounded-lg text-white bg-sky-600 hover:bg-sky-700 transition-colors">Create Exam</button>
                        </form>
                        <div id="examFeedback" class="text-sm mt-2"></div>
                    </div>
                    <!-- Existing Exams List -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium text-slate-900">Existing Exams</h3>
                        <div id="examListAdmin" class="h-[32rem] overflow-y-auto custom-scrollbar bg-slate-100 p-3 rounded-lg border border-slate-200"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Portal Views -->
        <div id="studentLoginView" class="view hidden flex items-center justify-center w-full h-full">
            <div class="bg-white p-10 rounded-xl shadow-2xl max-w-md mx-auto w-full">
                <button onclick="showView('mainView')" class="text-blue-600 hover:text-blue-800 mb-6">&larr; Back</button>
                <h2 class="text-3xl font-bold mb-8 text-center">Student Portal</h2>
                <form id="studentLoginForm" class="space-y-4">
                    <input type="text" id="studentId" placeholder="Enter Your Unique ID" required class="mt-1 block w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-lg text-white bg-slate-700 hover:bg-slate-800 transition-colors font-semibold">Login</button>
                </form>
                <div id="studentLoginError" class="mt-4 text-center text-red-600 font-medium"></div>
            </div>
        </div>
        <div id="studentDashboardView" class="view hidden bg-white p-8 rounded-xl shadow-xl max-w-3xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Welcome, <span id="studentNameHeader"></span>!</h2>
                <button onclick="logoutStudent()" class="text-sm text-sky-600 hover:text-sky-800 font-semibold">Logout</button>
            </div>
            <!-- Student Tabs -->
            <div class="border-b border-slate-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button onclick="switchStudentTab('studentProfileTab', this)" class="student-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">Profile</button>
                    <button onclick="switchStudentTab('studentAnnouncementsTab', this)" class="student-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500">Announcements</button>
                    <button onclick="switchStudentTab('studentRoutineTab', this)" class="student-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500">Class Routine</button>
                    <button onclick="switchStudentTab('studentExamsTab', this)" class="student-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500">Mock Exams</button>
                </nav>
            </div>
            <!-- Student Profile Tab -->
            <div id="studentProfileTab" class="student-tab-content mt-8">
                <div class="space-y-4 bg-slate-50 p-6 rounded-lg border border-slate-200">
                    <p><strong class="text-slate-500 w-24 inline-block">Name:</strong> <span id="dashboardStudentName">-</span></p>
                    <p><strong class="text-slate-500 w-24 inline-block">Batch:</strong> <span id="dashboardStudentBatch">-</span></p>
                    <p><strong class="text-slate-500 w-24 inline-block">Email:</strong> <span id="dashboardStudentEmail">-</span></p>
                    <p><strong class="text-slate-500 w-24 inline-block">Unique ID:</strong> <span id="dashboardStudentId">-</span></p>
                </div>
            </div>
            <!-- Student Announcements Tab -->
            <div id="studentAnnouncementsTab" class="student-tab-content hidden mt-8 h-96 overflow-y-auto custom-scrollbar"></div>
            <!-- Student Routine Tab -->
            <div id="studentRoutineTab" class="student-tab-content hidden mt-8">
                <div id="studentRoutineContent" class="bg-slate-50 p-6 rounded-lg whitespace-pre-wrap border border-slate-200"></div>
            </div>
            <!-- Student Exams Tab -->
            <div id="studentExamsTab" class="student-tab-content hidden mt-8">
                 <div id="examListStudent" class="space-y-4"></div>
            </div>
        </div>
        
        <!-- Exam Taking View -->
        <div id="examTakingView" class="view hidden bg-white p-8 rounded-xl shadow-xl max-w-3xl mx-auto">
            <div class="flex justify-between items-center border-b border-slate-200 pb-4 mb-6">
                <h2 id="examTakingTitle" class="text-2xl font-bold">Exam Title</h2>
                <div id="examTimer" class="text-xl font-mono font-bold text-red-600">00:00</div>
            </div>
            <div id="examQuestionContainer">
                <!-- Current question will be rendered here -->
            </div>
            <div class="flex justify-between mt-8">
                <button onclick="prevQuestion()" id="prevQuestionBtn" class="px-6 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors">Previous</button>
                <button onclick="nextQuestion()" id="nextQuestionBtn" class="px-6 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-colors">Next</button>
                <button onclick="finishExam()" id="finishExamBtn" class="hidden px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Finish Exam</button>
            </div>
        </div>
        
        <!-- Exam Results View -->
        <div id="examResultsView" class="view hidden bg-white p-8 rounded-xl shadow-xl max-w-3xl mx-auto">
             <h2 class="text-2xl font-bold mb-4">Exam Results</h2>
             <div id="examResultSummary" class="text-center bg-slate-50 p-6 rounded-lg mb-6 border border-slate-200"></div>
             <div id="examReviewContainer" class="space-y-4 h-96 overflow-y-auto custom-scrollbar pr-2"></div>
             <button onclick="showView('studentDashboardView')" class="w-full mt-6 py-3 px-4 rounded-lg text-white bg-sky-600 hover:bg-sky-700 transition-colors">Back to Dashboard</button>
        </div>

        <!-- All Modals -->
        <div id="editStudentModal" class="modal hidden fixed inset-0 bg-slate-900 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
            <div class="relative mx-auto p-8 border w-full max-w-lg shadow-lg rounded-md bg-white">
                <h3 class="text-lg font-medium text-slate-900 mb-4">Edit Student Information</h3>
                <form id="editStudentForm" class="space-y-4">
                    <input type="hidden" id="editStudentId">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="editStudentName" placeholder="Student Name" required class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input type="email" id="editStudentEmail" placeholder="Student Email" required class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <select id="editStudentBatch" required class="block w-full px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    
                    <div class="border-t border-slate-200 pt-4 mt-4">
                        <h4 class="font-medium text-slate-800 mb-2">Payment History</h4>
                        <div id="paymentHistoryContainer" class="space-y-2 text-sm"></div>
                        <button type="button" id="addInstallmentBtn" onclick="showNewInstallmentFields()" class="hidden mt-2 text-sm text-sky-600 hover:text-sky-800 font-semibold">+ Add Second Installment</button>
                    </div>

                    <div id="newInstallmentSection" class="hidden space-y-3 border-t border-slate-200 pt-4 mt-4">
                         <h4 class="font-medium text-slate-800">New Installment Details</h4>
                         <select id="newPaymentStatus" class="block w-full px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="second-installment">Second Installment</option>
                            <option value="paid">Paid</option>
                        </select>
                        <input type="text" id="newPaymentAmount" placeholder="Amount" class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input type="date" id="newPaymentDate" class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>

                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 transition-colors">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="editPaymentModal" class="modal hidden fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center">
            <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-md bg-white">
                <h3 class="text-lg font-medium text-slate-900 mb-4">Edit Payment Record</h3>
                <form id="editPaymentForm" class="space-y-4">
                    <input type="hidden" id="editPaymentStudentId">
                    <input type="hidden" id="editPaymentIndex">
                    <select id="editPaymentStatus" required class="block w-full px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <option value="not-paid">Not Paid</option>
                        <option value="first-installment">First Installment</option>
                        <option value="second-installment">Second Installment</option>
                        <option value="one-time">One Time Payment</option>
                        <option value="paid">Paid</option>
                    </select>
                    <input type="text" id="editPaymentAmount" placeholder="Amount" required class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <input type="date" id="editPaymentDate" required class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" onclick="closePaymentEditModal()" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 transition-colors">Update Payment</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="editExamModal" class="modal hidden fixed inset-0 bg-slate-900 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
            <div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <h3 class="text-lg font-medium text-slate-900 mb-4">Edit Exam</h3>
                <form id="editExamForm" class="space-y-4">
                    <input type="hidden" id="editExamId">
                    <input type="text" id="editExamTitle" placeholder="Exam Title" required class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <div class="grid grid-cols-2 gap-4">
                        <select id="editExamBatch" required class="block w-full px-3 py-2 border border-slate-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"><option value="">Assign to Batch</option></select>
                        <input type="number" id="editExamDuration" placeholder="Duration (minutes)" required class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <input type="number" id="editExamPassPercent" placeholder="Pass Percentage %" required min="1" max="100" class="block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                    
                    <div class="border-t border-slate-200 pt-4">
                        <h4 class="font-medium text-slate-800 mb-2">Questions</h4>
                        <div id="editQuestionsContainer" class="space-y-4 max-h-64 overflow-y-auto custom-scrollbar pr-2">
                            <!-- Existing questions will be rendered here -->
                        </div>
                        <button type="button" onclick="addQuestionToEditForm()" class="mt-4 text-sm text-sky-600 hover:text-sky-800 font-semibold">+ Add Question</button>
                    </div>
                    
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" onclick="closeEditExamModal()" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 transition-colors">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

    </div>
    
    <footer class="text-center mt-8 py-4">
        <p class="text-sm text-slate-500">Developed by Sheikh Istemam Ahmed</p>
        <p class="text-sm text-slate-500">Email: istemamahmed@outlook.com</p>
    </footer>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            query as firestoreQuery,
            where,
            onSnapshot,
            orderBy
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // IMPORTANT: REPLACE WITH YOUR FIREBASE CONFIGURATION
      const firebaseConfig = {
  apiKey: "AIzaSyDsu5eppaC_Gxbr_byqxd4W9UcIykB-Xb8",
  authDomain: "student-management-f081d.firebaseapp.com",
  projectId: "student-management-f081d",
  storageBucket: "student-management-f081d.firebasestorage.app",
  messagingSenderId: "268768838288",
  appId: "1:268768838288:web:fc46184ba5ab9456148e15"
};

        // Initialize Firebase
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            document.body.innerHTML = `
                <div class="w-full h-screen flex items-center justify-center">
                    <div class="bg-white p-8 rounded-xl shadow-xl text-center max-w-lg mx-auto">
                        <h1 class="text-2xl font-bold text-red-600 mb-4">Firebase Not Configured</h1>
                        <p class="text-slate-600">Please replace the placeholder <strong>firebaseConfig</strong> values in the HTML file with your project's actual Firebase configuration keys to run the application.</p>
                    </div>
                </div>
            `;
            throw new Error("Firebase is not configured. Please update firebaseConfig in the script.");
        }
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentStudent = null; // Track logged-in student
        let examTimerInterval;
        let studentAnswers = {};
        let allStudents = [];
        let allBatches = [];
        
        // Unsubscribe functions for Firestore listeners
        let unsubscribeStudents, unsubscribeBatches, unsubscribeAnnouncements, unsubscribeRoutines, unsubscribeExams;

        // --- DATABASE FUNCTIONS (NOW WITH FIREBASE!) ---
        async function registerAdmin(email, password) { return createUserWithEmailAndPassword(auth, email, password); }
        async function loginAdmin(email, password) { return signInWithEmailAndPassword(auth, email, password); }
        async function createBatch(batchName) { return addDoc(collection(db, "batches"), { name: batchName }); }
        async function getBatchById(batchId) { return allBatches.find(b => b.id === batchId) || null; }
        function generateUniqueId(name) { const nameParts = name.trim().split(' '); let initials = nameParts[0].charAt(0); if (nameParts.length > 1) initials += nameParts[nameParts.length - 1].charAt(0); else if (name.length > 1) initials += name.charAt(1); return `${initials.toUpperCase()}-${Math.floor(1000 + Math.random() * 9000)}`; }
        async function addStudent(studentData) { const studentId = generateUniqueId(studentData.name); const studentRef = doc(db, "students", studentId); await setDoc(studentRef, { name: studentData.name, email: studentData.email, batchId: studentData.batchId, paymentInfo: [{ status: studentData.paymentStatus, amount: studentData.paymentAmount, date: studentData.paymentDate }], passedExams: [] }); return { id: studentId, ...studentData }; }
        async function findStudentById(id) { const docRef = doc(db, "students", id); const docSnap = await getDoc(docRef); return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null; }
        async function updateStudent(id, newData) { const studentRef = doc(db, "students", id); if (newData.newPayment) { const student = await findStudentById(id); const updatedPayments = [...student.paymentInfo, newData.newPayment]; await updateDoc(studentRef, { name: newData.name, email: newData.email, batchId: newData.batchId, paymentInfo: updatedPayments }); } else { await updateDoc(studentRef, { name: newData.name, email: newData.email, batchId: newData.batchId }); } }
        async function updateStudentPayment(studentId, paymentIndex, paymentData) { const student = await findStudentById(studentId); if (student) { student.paymentInfo[paymentIndex] = paymentData; await updateDoc(doc(db, "students", studentId), { paymentInfo: student.paymentInfo }); } }
        async function deleteStudent(id) { await deleteDoc(doc(db, "students", id)); }
        async function addAnnouncement(title, content, batchId) { return addDoc(collection(db, "announcements"), { title, content, batchId, timestamp: new Date().toISOString() }); }
        async function deleteAnnouncement(id) { await deleteDoc(doc(db, "announcements", id)); }
        async function setRoutine(batchId, content) { const routineRef = doc(db, "routines", batchId); await setDoc(routineRef, { content }); }
        async function getRoutineForBatch(batchId) { const docRef = doc(db, "routines", batchId); const docSnap = await getDoc(docRef); return docSnap.exists() ? docSnap.data() : null; }
        async function addExam(examData) { return addDoc(collection(db, "exams"), examData); }
        async function getExamById(id) { const docRef = doc(db, "exams", id); const docSnap = await getDoc(docRef); return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null; }
        async function getExamsForBatch(batchId) { const q = firestoreQuery(collection(db, "exams"), where("batchId", "==", batchId)); const querySnapshot = await getDocs(q); return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); }
        async function deleteExam(id) { await deleteDoc(doc(db, "exams", id)); }
        async function updateExam(id, newData) { const examRef = doc(db, "exams", id); await updateDoc(examRef, newData); }

        // --- UI & VIEW MANAGEMENT ---
        window.showView = function(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.toggle('hidden', view.id !== viewId));
            if (viewId === 'adminDashboardView') {
                attachRealtimeListeners();
            } else {
                detachRealtimeListeners();
            }
        }

        window.switchTab = function(tabId, button) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.admin-tab').forEach(b => { b.classList.remove('tab-active'); b.classList.add('text-slate-500'); });
            button.classList.add('tab-active');
            button.classList.remove('text-slate-500');
        }
        
        window.switchStudentTab = function(tabId, button) {
            document.querySelectorAll('.student-tab-content').forEach(tc => tc.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.student-tab').forEach(b => { b.classList.remove('tab-active'); b.classList.add('text-slate-500'); });
            button.classList.add('tab-active');
            button.classList.remove('text-slate-500');
        }
        
        // --- REALTIME LISTENERS ---
        function attachRealtimeListeners() {
            unsubscribeStudents = onSnapshot(collection(db, "students"), (snapshot) => {
                allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                handleSearch(); // Re-run search with the new full list
            });
            unsubscribeBatches = onSnapshot(collection(db, "batches"), (snapshot) => {
                allBatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBatchList();
                renderBatchesInDropdown(allBatches);
                renderBatchesForExport(allBatches);
                renderBatchesForRoutineSelect(allBatches);
                renderBatchesForExamSelect(allBatches);
            });
            unsubscribeAnnouncements = onSnapshot(firestoreQuery(collection(db, "announcements"), orderBy("timestamp", "desc")), (snapshot) => {
                const announcements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAnnouncementsAdmin(announcements);
            });
            unsubscribeExams = onSnapshot(collection(db, "exams"), (snapshot) => {
                const exams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderExamsAdmin(exams);
            });
        }
        
        function detachRealtimeListeners() {
            if (unsubscribeStudents) unsubscribeStudents();
            if (unsubscribeBatches) unsubscribeBatches();
            if (unsubscribeAnnouncements) unsubscribeAnnouncements();
            if (unsubscribeExams) unsubscribeExams();
        }

        // --- RENDER FUNCTIONS (now take data as argument) ---
        function renderBatchesInDropdown(batches) { const selects = [document.getElementById('studentBatch'), document.getElementById('editStudentBatch'), document.getElementById('announcementBatchSelect')]; selects.forEach(select => { const currentVal = select.value; let firstOption = '<option value="">Assign to Batch</option>'; if(select.id === 'announcementBatchSelect') firstOption = '<option value="all">All Batches</option>'; select.innerHTML = firstOption; batches.forEach(batch => { const option = document.createElement('option'); option.value = batch.id; option.textContent = batch.name; select.appendChild(option); }); select.value = currentVal; }); }
        function renderBatchesForExport(batches) { const select = document.getElementById('exportBatchSelect'); select.innerHTML = '<option value="">Select a Batch</option>'; batches.forEach(batch => { const option = document.createElement('option'); option.value = batch.id; option.textContent = batch.name; select.appendChild(option); }); }
        function renderBatchList() { const container = document.getElementById('batchList'); container.innerHTML = ''; if (allBatches.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center mt-4">No batches created yet.</p>`; return; } allBatches.forEach(batch => { const studentsInBatch = allStudents.filter(s => s.batchId === batch.id); let studentHTML = '<p class="text-sm text-slate-500 pl-4 py-2">No students in this batch.</p>'; if (studentsInBatch.length > 0) { studentHTML = studentsInBatch.map(s => `<div class="text-sm pl-4 py-2 border-t">${s.name}</div>`).join(''); } const accordionItem = ` <div class="bg-white mb-2 rounded-md shadow-sm border border-slate-200"> <button onclick="toggleAccordion(this)" class="w-full text-left p-3 font-semibold flex justify-between items-center"> <span>${batch.name}</span> <i class="fas fa-chevron-down transition-transform"></i> </button> <div class="accordion-content bg-slate-50 p-2"> <input type="text" oninput="handleInBatchSearch(this, '${batch.id}')" placeholder="Search in batch..." class="w-full p-2 mb-2 border border-slate-300 rounded-md"> <div id="student-list-${batch.id}">${studentHTML}</div> </div> </div>`; container.innerHTML += accordionItem; }); }
        window.toggleAccordion = function(button) { const content = button.nextElementSibling; const icon = button.querySelector('i'); if (content.style.maxHeight) { content.style.maxHeight = null; icon.classList.remove('rotate-180'); } else { content.style.maxHeight = content.scrollHeight + "px"; icon.classList.add('rotate-180'); } }
        function getPaymentStatusPill(status) { const statuses = { 'not-paid': 'bg-red-100 text-red-800', 'one-time': 'bg-green-100 text-green-800', 'first-installment': 'bg-yellow-100 text-yellow-800', 'second-installment': 'bg-blue-100 text-blue-800', 'paid': 'bg-green-100 text-green-800', }; const text = status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()); return `<span class="px-2 py-1 text-xs font-medium rounded-full ${statuses[status] || 'bg-slate-100 text-slate-800'}">${text}</span>`; }
        async function renderStudentList(studentList) { const container = document.getElementById('studentList'); container.innerHTML = ''; if (studentList.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center mt-4">No students found.</p>`; return; } for (const student of studentList) { const batch = await getBatchById(student.batchId); const latestPayment = student.paymentInfo[student.paymentInfo.length - 1]; const studentCard = ` <div class="bg-white p-3 mb-2 rounded-md shadow-sm border border-slate-200"> <div class="flex justify-between items-start"> <div> <p class="font-semibold text-slate-800">${student.name} <span class="text-sm font-normal text-slate-500">(${student.id})</span></p> <p class="text-sm text-slate-600">${student.email}</p> <p class="text-sm text-sky-600 font-medium mt-1">Batch: ${batch ? batch.name : 'N/A'}</p> </div> <div class="flex space-x-2"> <button onclick="openEditModal('${student.id}')" class="text-slate-500 hover:text-sky-600"><i class="fas fa-pencil-alt"></i></button> <button onclick="handleDeleteStudent('${student.id}')" class="text-slate-500 hover:text-red-600"><i class="fas fa-trash-alt"></i></button> </div> </div> <div class="mt-2 text-right flex justify-end items-center space-x-2"> <span class="text-sm text-slate-600">${latestPayment.amount} on ${latestPayment.date}</span> ${getPaymentStatusPill(latestPayment.status)} </div> </div>`; container.innerHTML += studentCard; } }
        function renderBatchesForRoutineSelect(batches) { const select = document.getElementById('routineBatchSelect'); select.innerHTML = '<option value="">Select a Batch</option>'; batches.forEach(batch => { const option = document.createElement('option'); option.value = batch.id; option.textContent = batch.name; select.appendChild(option); }); }
        async function renderAnnouncementsAdmin(announcements) { const container = document.getElementById('announcementListAdmin'); container.innerHTML = ''; if (announcements.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center mt-4">No announcements posted.</p>`; return; } for (const a of announcements) { const batch = a.batchId === 'all' ? { name: 'All Batches' } : await getBatchById(a.batchId); container.innerHTML += ` <div class="bg-white p-3 rounded-md shadow-sm border border-slate-200"> <div class="flex justify-between items-start"> <p class="font-semibold">${a.title}</p> <button onclick="handleDeleteAnnouncement('${a.id}')" class="text-slate-400 hover:text-red-500 text-sm"><i class="fas fa-trash"></i></button> </div> <p class="text-xs text-sky-600 font-semibold">${batch ? batch.name : 'Unknown Batch'}</p> <p class="text-sm text-slate-600 mt-1">${a.content}</p> <p class="text-xs text-slate-400 mt-2">${new Date(a.timestamp).toLocaleString()}</p> </div>`; } }
        async function renderAnnouncementsStudent(batchId) { const container = document.getElementById('studentAnnouncementsTab'); container.innerHTML = ''; const q = firestoreQuery(collection(db, "announcements"), where("batchId", "in", ["all", batchId])); const querySnapshot = await getDocs(q); let announcements = querySnapshot.docs.map(doc => doc.data()); announcements.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); if (announcements.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center mt-8">No announcements at this time.</p>`; return; } announcements.forEach(a => { container.innerHTML += ` <div class="bg-white p-4 mb-3 rounded-lg shadow-sm border border-slate-200"> <p class="font-bold text-lg text-sky-700">${a.title}</p> <p class="text-slate-700 mt-2">${a.content}</p> <p class="text-sm text-slate-500 mt-3">${new Date(a.timestamp).toLocaleString()}</p> </div>`; }); }
        async function renderRoutineStudent(batchId) { const container = document.getElementById('studentRoutineContent'); const routine = await getRoutineForBatch(batchId); if (routine) { container.textContent = routine.content; } else { container.textContent = 'No class routine has been set for your batch yet.'; } }
        function renderBatchesForExamSelect(batches) { const selects = [document.getElementById('examBatch'), document.getElementById('editExamBatch')]; selects.forEach(select => { select.innerHTML = '<option value="">Assign to Batch</option>'; batches.forEach(batch => { const option = document.createElement('option'); option.value = batch.id; option.textContent = batch.name; select.appendChild(option); }); }); }
        async function renderExamsAdmin(exams) { const container = document.getElementById('examListAdmin'); container.innerHTML = ''; if (exams.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center mt-4">No exams created yet.</p>`; return; } for (const exam of exams) { const batch = await getBatchById(exam.batchId); container.innerHTML += ` <div class="bg-white p-3 rounded-md shadow-sm border border-slate-200"> <div class="flex justify-between items-start"> <div> <p class="font-semibold">${exam.title}</p> <p class="text-sm text-slate-600 mt-1">Batch: ${batch ? batch.name : 'N/A'} | ${exam.questions.length} Questions</p> </div> <div class="flex space-x-3"> <button onclick="openEditExamModal('${exam.id}')" class="text-slate-400 hover:text-sky-600 text-sm"><i class="fas fa-pencil-alt"></i></button> <button onclick="handleDeleteExam('${exam.id}')" class="text-slate-400 hover:text-red-500 text-sm"><i class="fas fa-trash"></i></button> </div> </div> </div>`; } }
        async function renderExamsStudent(student) { const container = document.getElementById('examListStudent'); const examsForBatch = await getExamsForBatch(student.batchId); const sortedExams = examsForBatch.sort((a, b) => parseInt(a.id.split('-')[1]) - parseInt(b.id.split('-')[1])); container.innerHTML = ''; if (sortedExams.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center mt-8">No exams available for your batch.</p>`; return; } for (const exam of sortedExams) { const buttonHTML = `<button onclick="startExam('${exam.id}')" class="px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-colors">Start Exam</button>`; container.innerHTML += ` <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex justify-between items-center"> <div> <p class="font-bold text-lg">${exam.title}</p> <p class="text-sm text-slate-600">${exam.questions.length} questions | ${exam.duration} minutes</p> </div> ${buttonHTML} </div>`; } }

        // --- MODAL FUNCTIONS ---
        window.openEditModal = async function(studentId) { const student = await findStudentById(studentId); if (!student) return; document.getElementById('newInstallmentSection').classList.add('hidden'); document.getElementById('addInstallmentBtn').classList.add('hidden'); document.getElementById('newPaymentAmount').value = ''; document.getElementById('newPaymentDate').value = ''; document.getElementById('editStudentId').value = student.id; document.getElementById('editStudentName').value = student.name; document.getElementById('editStudentEmail').value = student.email; renderBatchesInDropdown(allBatches); document.getElementById('editStudentBatch').value = student.batchId; const historyContainer = document.getElementById('paymentHistoryContainer'); historyContainer.innerHTML = ''; student.paymentInfo.forEach((p, index) => { historyContainer.innerHTML += ` <div class="flex justify-between items-center bg-slate-50 p-2 rounded-md"> <div class="flex-1">${getPaymentStatusPill(p.status)}</div> <div class="flex-1 font-medium text-center">${p.amount}</div> <div class="flex-1 text-slate-500 text-center">${p.date}</div> <button type="button" onclick="openPaymentEditModal('${student.id}', ${index})" class="text-slate-500 hover:text-sky-600 ml-4"><i class="fas fa-pencil-alt"></i></button> </div>`; }); if (student.paymentInfo.length < 2 && student.paymentInfo[0].status !== 'paid' && student.paymentInfo[0].status !== 'one-time') { document.getElementById('addInstallmentBtn').classList.remove('hidden'); } document.getElementById('editStudentModal').classList.remove('hidden'); }
        window.showNewInstallmentFields = function() { document.getElementById('newInstallmentSection').classList.remove('hidden'); document.getElementById('newPaymentDate').valueAsDate = new Date(); document.getElementById('addInstallmentBtn').classList.add('hidden'); }
        window.closeEditModal = function() { document.getElementById('editStudentModal').classList.add('hidden'); }
        window.openPaymentEditModal = async function(studentId, paymentIndex) { const student = await findStudentById(studentId); const payment = student.paymentInfo[paymentIndex]; if (!payment) return; document.getElementById('editPaymentStudentId').value = studentId; document.getElementById('editPaymentIndex').value = paymentIndex; document.getElementById('editPaymentStatus').value = payment.status; document.getElementById('editPaymentAmount').value = payment.amount; document.getElementById('editPaymentDate').value = payment.date; document.getElementById('editPaymentModal').classList.remove('hidden'); }
        window.closePaymentEditModal = function() { document.getElementById('editPaymentModal').classList.add('hidden'); }
        let editQuestionCounter = 0;
        window.openEditExamModal = async function(examId) { const exam = await getExamById(examId); if (!exam) return; document.getElementById('editExamId').value = exam.id; document.getElementById('editExamTitle').value = exam.title; renderBatchesForExamSelect(allBatches); document.getElementById('editExamBatch').value = exam.batchId; document.getElementById('editExamDuration').value = exam.duration; document.getElementById('editExamPassPercent').value = exam.passPercent; const questionsContainer = document.getElementById('editQuestionsContainer'); questionsContainer.innerHTML = ''; editQuestionCounter = 0; exam.questions.forEach(q => { editQuestionCounter++; const questionHTML = ` <div id="edit-q-${editQuestionCounter}" class="p-3 border border-slate-200 rounded bg-white space-y-2"> <div class="flex justify-between items-center"> <label class="font-medium text-sm">Question ${editQuestionCounter}</label> <button type="button" onclick="removeQuestion('edit-q-${editQuestionCounter}')" class="text-red-500 text-xs"><i class="fas fa-times-circle"></i> Remove</button> </div> <textarea name="q-text" placeholder="Question Text" required class="w-full p-2 border border-slate-300 rounded">${q.text}</textarea> <input type="text" name="q-img" placeholder="Image URL (Optional)" value="${q.imageUrl || ''}" class="w-full p-2 border border-slate-300 rounded"> ${q.options.map((opt, i) => ` <div class="flex items-center space-x-2"> <input type="radio" name="edit-q-correct-${editQuestionCounter}" value="${i}" required ${q.correctAnswer === i ? 'checked' : ''}> <input type="text" name="q-option" placeholder="Option ${i+1}" value="${opt}" required class="w-full p-2 border border-slate-300 rounded"> </div>`).join('')} <textarea name="q-explanation" placeholder="Explanation" required class="w-full p-2 border border-slate-300 rounded">${q.explanation}</textarea> </div>`; questionsContainer.insertAdjacentHTML('beforeend', questionHTML); }); document.getElementById('editExamModal').classList.remove('hidden'); }
        window.addQuestionToEditForm = function() { editQuestionCounter++; const questionsContainer = document.getElementById('editQuestionsContainer'); const questionHTML = ` <div id="edit-q-${editQuestionCounter}" class="p-3 border border-slate-200 rounded bg-white space-y-2"> <div class="flex justify-between items-center"> <label class="font-medium text-sm">Question ${editQuestionCounter}</label> <button type="button" onclick="removeQuestion('edit-q-${editQuestionCounter}')" class="text-red-500 text-xs"><i class="fas fa-times-circle"></i> Remove</button> </div> <textarea name="q-text" placeholder="Question Text" required class="w-full p-2 border border-slate-300 rounded"></textarea> <input type="text" name="q-img" placeholder="Image URL (Optional)" class="w-full p-2 border border-slate-300 rounded"> ${[...Array(5).keys()].map(i => ` <div class="flex items-center space-x-2"> <input type="radio" name="edit-q-correct-${editQuestionCounter}" value="${i}" required> <input type="text" name="q-option" placeholder="Option ${i+1}" required class="w-full p-2 border border-slate-300 rounded"> </div>`).join('')} <textarea name="q-explanation" placeholder="Explanation" required class="w-full p-2 border border-slate-300 rounded"></textarea> </div>`; questionsContainer.insertAdjacentHTML('beforeend', questionHTML); }
        window.closeEditExamModal = function() { document.getElementById('editExamModal').classList.add('hidden'); }

        // --- EXAM FORM DYNAMIC QUESTIONS ---
        let questionCounter = 0;
        window.addQuestion = function() { questionCounter++; const questionsContainer = document.getElementById('questionsContainer'); const questionHTML = ` <div id="q-${questionCounter}" class="p-3 border border-slate-200 rounded bg-white space-y-2"> <div class="flex justify-between items-center"> <label class="font-medium text-sm">Question ${questionCounter}</label> <button type="button" onclick="removeQuestion('q-${questionCounter}')" class="text-red-500 text-xs"><i class="fas fa-times-circle"></i> Remove</button> </div> <textarea name="q-text" placeholder="Question Text" required class="w-full p-2 border border-slate-300 rounded"></textarea> <input type="text" name="q-img" placeholder="Image URL (Optional)" class="w-full p-2 border border-slate-300 rounded"> ${[...Array(5).keys()].map(i => ` <div class="flex items-center space-x-2"> <input type="radio" name="q-correct-${questionCounter}" value="${i}" required> <input type="text" name="q-option" placeholder="Option ${i+1}" required class="w-full p-2 border border-slate-300 rounded"> </div>`).join('')} <textarea name="q-explanation" placeholder="Explanation for correct answer" required class="w-full p-2 border border-slate-300 rounded"></textarea> </div>`; questionsContainer.insertAdjacentHTML('beforeend', questionHTML); }
        window.removeQuestion = function(id) { document.getElementById(id).remove(); }

        // --- EXAM LOGIC ---
        let currentExam = null; let currentQuestionIndex = 0;
        window.startExam = async function(examId) { currentExam = await getExamById(examId); currentQuestionIndex = 0; studentAnswers[examId] = {}; showView('examTakingView'); document.getElementById('examTakingTitle').textContent = currentExam.title; renderCurrentQuestion(); startTimer(currentExam.duration); }
        function renderCurrentQuestion() { const question = currentExam.questions[currentQuestionIndex]; const container = document.getElementById('examQuestionContainer'); const savedAnswer = studentAnswers[currentExam.id][question.id]; container.innerHTML = ` <p class="font-semibold text-lg mb-4">${currentQuestionIndex + 1}. ${question.text}</p> ${question.imageUrl ? `<img src="${question.imageUrl}" class="max-w-sm mx-auto mb-4 rounded-lg">` : ''} <div class="space-y-3"> ${question.options.map((opt, i) => ` <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors ${savedAnswer === i ? 'selected-answer' : ''}"> <input type="radio" name="exam-option" value="${i}" onchange="selectAnswer(${i})" ${savedAnswer === i ? 'checked' : ''}> <span class="ml-3">${opt}</span> </label>`).join('')} </div>`; document.getElementById('prevQuestionBtn').classList.toggle('hidden', currentQuestionIndex === 0); document.getElementById('nextQuestionBtn').classList.toggle('hidden', currentQuestionIndex === currentExam.questions.length - 1); document.getElementById('finishExamBtn').classList.toggle('hidden', currentQuestionIndex !== currentExam.questions.length - 1); }
        window.selectAnswer = function(optionIndex) { const questionId = currentExam.questions[currentQuestionIndex].id; studentAnswers[currentExam.id][questionId] = optionIndex; renderCurrentQuestion(); }
        window.nextQuestion = function() { if(currentQuestionIndex < currentExam.questions.length - 1) { currentQuestionIndex++; renderCurrentQuestion(); } }
        window.prevQuestion = function() { if(currentQuestionIndex > 0) { currentQuestionIndex--; renderCurrentQuestion(); } }
        function startTimer(minutes) { let seconds = minutes * 60; const timerEl = document.getElementById('examTimer'); clearInterval(examTimerInterval); examTimerInterval = setInterval(() => { const min = Math.floor(seconds / 60); const sec = seconds % 60; timerEl.textContent = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`; seconds--; if (seconds < 0) { clearInterval(examTimerInterval); finishExam(); } }, 1000); }
        async function finishExam() { clearInterval(examTimerInterval); let score = 0; currentExam.questions.forEach(q => { if (studentAnswers[currentExam.id][q.id] === q.correctAnswer) { score++; } }); const percentage = (score / currentExam.questions.length) * 100; const passed = percentage >= currentExam.passPercent; if (passed && currentStudent) { if (!currentStudent.passedExams) { currentStudent.passedExams = []; } if (!currentStudent.passedExams.includes(currentExam.id)) { currentStudent.passedExams.push(currentExam.id); await updateDoc(doc(db, "students", currentStudent.id), { passedExams: currentStudent.passedExams }); currentStudent = await findStudentById(currentStudent.id); } } const summaryEl = document.getElementById('examResultSummary'); summaryEl.innerHTML = ` <p class="text-4xl font-bold ${passed ? 'text-green-600' : 'text-red-600'}">${passed ? 'Passed!' : 'Failed'}</p> <p class="text-lg mt-2">Your Score: ${score} out of ${currentExam.questions.length} (${percentage.toFixed(2)}%)</p> <p class="text-sm text-slate-600">Passing score was ${currentExam.passPercent}%</p>`; renderExamReview(); showView('examResultsView'); renderExamsStudent(currentStudent); }
        window.finishExam = finishExam;
        function renderExamReview() { const container = document.getElementById('examReviewContainer'); container.innerHTML = ''; currentExam.questions.forEach((q, index) => { const studentAnswerIndex = studentAnswers[currentExam.id][q.id]; let answerHTML = q.options.map((opt, i) => { let classes = 'p-3 border border-slate-200 rounded-lg'; if (i === q.correctAnswer) classes += ' correct-answer'; else if (i === studentAnswerIndex) classes += ' incorrect-answer'; return `<div class="${classes}">${opt}</div>`; }).join(''); container.innerHTML += ` <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200"> <p class="font-semibold">${index + 1}. ${q.text}</p> ${q.imageUrl ? `<img src="${q.imageUrl}" class="max-w-xs my-2 rounded">` : ''} <div class="space-y-2 mt-3">${answerHTML}</div> <div class="mt-3 p-3 bg-sky-50 rounded-lg"> <p class="font-semibold text-sm text-sky-800">Explanation:</p> <p class="text-sm text-sky-700">${q.explanation}</p> </div> </div>`; }); }
        
        // --- EVENT HANDLERS ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('paymentDate').valueAsDate = new Date();
            showView('mainView');

            // Attach all event listeners here to ensure DOM is loaded
            document.getElementById('exportBtn').addEventListener('click', async function() { const batchId = document.getElementById('exportBatchSelect').value; const feedback = document.getElementById('exportFeedback'); if (!batchId) { feedback.innerHTML = `<p class="text-red-500">Please select a batch to export.</p>`; return; } feedback.innerHTML = ''; const batch = await getBatchById(batchId); const q = firestoreQuery(collection(db, "students"), where("batchId", "==", batchId)); const querySnapshot = await getDocs(q); const studentsToExport = querySnapshot.docs.map(doc => doc.data()); if (studentsToExport.length === 0) { feedback.innerHTML = `<p class="text-yellow-500">This batch has no students to export.</p>`; return; } const dataForSheet = studentsToExport.map(student => { const firstInstallment = student.paymentInfo[0]; const secondInstallment = student.paymentInfo[1]; return { 'Name': student.name, 'Email': student.email, 'First Installment Date': firstInstallment ? firstInstallment.date : 'N/A', 'First Installment Amount': firstInstallment ? firstInstallment.amount : 'N/A', 'Second Installment Date': secondInstallment ? secondInstallment.date : 'N/A', 'Second Installment Amount': secondInstallment ? secondInstallment.amount : 'N/A', }; }); const worksheet = XLSX.utils.json_to_sheet(dataForSheet); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, 'Students'); XLSX.writeFile(workbook, `${batch.name.replace(/ /g,"_")}_Students.xlsx`); });
            document.getElementById('adminLoginForm').addEventListener('submit', async function(e) { e.preventDefault(); const email = document.getElementById('adminLoginEmail').value; const password = document.getElementById('adminLoginPassword').value; const feedback = document.getElementById('adminLoginFeedback'); try { await loginAdmin(email, password); } catch(error) { feedback.textContent = error.message; } });
            document.getElementById('batchForm').addEventListener('submit', async function(e) { e.preventDefault(); const batchName = document.getElementById('batchName').value; const feedback = document.getElementById('batchFeedback'); try { await createBatch(batchName); feedback.innerHTML = `<p class="text-green-600">Batch created.</p>`; this.reset(); } catch (error) { feedback.innerHTML = `<p class="text-red-600">${error.message}</p>`; } });
            document.getElementById('adminForm').addEventListener('submit', async function(e) { e.preventDefault(); const studentData = { name: document.getElementById('studentName').value, email: document.getElementById('studentEmail').value, batchId: document.getElementById('studentBatch').value, paymentStatus: document.getElementById('paymentStatus').value, paymentAmount: document.getElementById('paymentAmount').value, paymentDate: document.getElementById('paymentDate').value }; const feedback = document.getElementById('adminFeedback'); if (!studentData.name || !studentData.email || !studentData.batchId || !studentData.paymentStatus || !studentData.paymentAmount || !studentData.paymentDate) { feedback.innerHTML = `<p class="text-red-500">Please fill out all fields.</p>`; return; } const created = await addStudent(studentData); feedback.innerHTML = `<p class="text-green-600">Student created with ID: <strong>${created.id}</strong></p>`; this.reset(); document.getElementById('paymentDate').valueAsDate = new Date(); });
            document.getElementById('editStudentForm').addEventListener('submit', async function(e) { e.preventDefault(); const studentId = document.getElementById('editStudentId').value; const updatedData = { name: document.getElementById('editStudentName').value, email: document.getElementById('editStudentEmail').value, batchId: document.getElementById('editStudentBatch').value }; const newPaymentAmount = document.getElementById('newPaymentAmount').value; if (newPaymentAmount) { updatedData.newPayment = { status: document.getElementById('newPaymentStatus').value, amount: newPaymentAmount, date: document.getElementById('newPaymentDate').value }; } await updateStudent(studentId, updatedData); closeEditModal(); });
            document.getElementById('editPaymentForm').addEventListener('submit', async function(e) { e.preventDefault(); const studentId = document.getElementById('editPaymentStudentId').value; const paymentIndex = document.getElementById('editPaymentIndex').value; const paymentData = { status: document.getElementById('editPaymentStatus').value, amount: document.getElementById('editPaymentAmount').value, date: document.getElementById('editPaymentDate').value }; await updateStudentPayment(studentId, paymentIndex, paymentData); closePaymentEditModal(); openEditModal(studentId); });
            document.getElementById('studentLoginForm').addEventListener('submit', async function(e){ e.preventDefault(); const student = await findStudentById(document.getElementById('studentId').value); if(student){ currentStudent = student; const batch = await getBatchById(student.batchId); document.getElementById('studentNameHeader').textContent = student.name.split(' ')[0]; document.getElementById('dashboardStudentName').textContent = student.name; document.getElementById('dashboardStudentEmail').textContent = student.email; document.getElementById('dashboardStudentId').textContent = student.id; document.getElementById('dashboardStudentBatch').textContent = batch ? batch.name : 'N/A'; renderAnnouncementsStudent(student.batchId); renderRoutineStudent(student.batchId); renderExamsStudent(student); showView('studentDashboardView'); switchStudentTab('studentProfileTab', document.querySelector('.student-tab')); } else { document.getElementById('studentLoginError').textContent = 'Invalid ID.'; } });
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('searchType').addEventListener('change', handleSearch);
            document.getElementById('announcementForm').addEventListener('submit', async function(e) { e.preventDefault(); const title = document.getElementById('announcementTitle').value; const content = document.getElementById('announcementContent').value; const batchId = document.getElementById('announcementBatchSelect').value; const feedback = document.getElementById('announcementFeedback'); await addAnnouncement(title, content, batchId); feedback.innerHTML = `<p class="text-green-600">Announcement posted.</p>`; this.reset(); setTimeout(() => feedback.innerHTML = '', 3000); });
            document.getElementById('routineForm').addEventListener('submit', async function(e) { e.preventDefault(); const batchId = document.getElementById('routineBatchSelect').value; const content = document.getElementById('routineContent').value; const feedback = document.getElementById('routineFeedback'); if (!batchId) { feedback.innerHTML = `<p class="text-red-500">Please select a batch.</p>`; return; } await setRoutine(batchId, content); feedback.innerHTML = `<p class="text-green-600">Routine has been set.</p>`; this.reset(); setTimeout(() => feedback.innerHTML = '', 3000); });
            document.getElementById('examForm').addEventListener('submit', async function(e) { e.preventDefault(); const examData = { title: document.getElementById('examTitle').value, batchId: document.getElementById('examBatch').value, duration: parseInt(document.getElementById('examDuration').value), passPercent: parseInt(document.getElementById('examPassPercent').value), questions: [] }; const questionNodes = document.querySelectorAll('#questionsContainer > div'); if (questionNodes.length === 0) { alert('Please add at least one question.'); return; } let questionRadioCounter = 0; questionNodes.forEach((node) => { questionRadioCounter++; const question = { id: `q-${questionRadioCounter}`, text: node.querySelector('[name="q-text"]').value, imageUrl: node.querySelector('[name="q-img"]').value || null, options: Array.from(node.querySelectorAll('[name="q-option"]')).map(opt => opt.value), correctAnswer: parseInt(node.querySelector(`[name="q-correct-${questionRadioCounter}"]:checked`).value), explanation: node.querySelector('[name="q-explanation"]').value }; examData.questions.push(question); }); await addExam(examData); document.getElementById('examFeedback').innerHTML = `<p class="text-green-600">Exam created successfully.</p>`; this.reset(); document.getElementById('questionsContainer').innerHTML = ''; questionCounter = 0; });
            document.getElementById('editExamForm').addEventListener('submit', async function(e) { e.preventDefault(); const examId = document.getElementById('editExamId').value; const updatedData = { title: document.getElementById('editExamTitle').value, batchId: document.getElementById('editExamBatch').value, duration: parseInt(document.getElementById('editExamDuration').value), passPercent: parseInt(document.getElementById('editExamPassPercent').value), questions: [] }; const questionNodes = document.querySelectorAll('#editQuestionsContainer > div'); questionNodes.forEach((node, index) => { const radioName = node.querySelector('input[type="radio"]').name; const question = { id: `q-${index}`, text: node.querySelector('[name="q-text"]').value, imageUrl: node.querySelector('[name="q-img"]').value || null, options: Array.from(node.querySelectorAll('[name="q-option"]')).map(opt => opt.value), correctAnswer: parseInt(node.querySelector(`[name="${radioName}"]:checked`).value), explanation: node.querySelector('[name="q-explanation"]').value }; updatedData.questions.push(question); }); await updateExam(examId, updatedData); closeEditExamModal(); });
        });

        async function handleSearch() { const queryText = document.getElementById('searchInput').value.toLowerCase(); const type = document.getElementById('searchType').value; let filteredStudents = allStudents; if (queryText) { if (type === 'name') { filteredStudents = allStudents.filter(s => s.name.toLowerCase().includes(queryText)); } else if (type === 'email') { filteredStudents = allStudents.filter(s => s.email.toLowerCase().includes(queryText)); } else if (type === 'batch') { const matchingBatches = allBatches.filter(b => b.name.toLowerCase().includes(queryText)); const matchingBatchIds = matchingBatches.map(b => b.id); filteredStudents = allStudents.filter(s => matchingBatchIds.includes(s.batchId)); } } renderStudentList(filteredStudents); }
        window.handleInBatchSearch = function(inputElement, batchId) {
            const queryText = inputElement.value.toLowerCase();
            const studentsInBatch = allStudents.filter(s => s.batchId === batchId);
            const container = document.getElementById(`student-list-${batchId}`);
            
            let filtered = studentsInBatch;
            if (queryText) {
                filtered = studentsInBatch.filter(s => s.name.toLowerCase().includes(queryText) || s.email.toLowerCase().includes(queryText));
            }
            
            let studentHTML = '<p class="text-sm text-slate-500 pl-4 py-2">No matching students found.</p>';
            if (filtered.length > 0) {
                studentHTML = filtered.map(s => `<div class="text-sm pl-4 py-2 border-t">${s.name}</div>`).join('');
            }
            container.innerHTML = studentHTML;
        }

        window.handleDeleteStudent = async function(id) { await deleteStudent(id); }
        window.handleDeleteAnnouncement = async function(id) { await deleteAnnouncement(id); }
        window.handleDeleteExam = async function(id) { await deleteExam(id); }
        window.logoutStudent = function() { currentStudent = null; showView('mainView'); }
        window.logoutAdmin = function() { signOut(auth); }
        
        onAuthStateChanged(auth, user => {
            if (user) {
                showView('adminDashboardView');
            } else {
                showView('mainView');
                detachRealtimeListeners();
            }
        });

    </script>
</body>
</html>
